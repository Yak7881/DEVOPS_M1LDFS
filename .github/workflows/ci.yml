name: CI ‚Äî DevOps Rooms

# üîÑ Ce pipeline se lance automatiquement sur chaque push et chaque pull request.
# Il v√©rifie que le repo est bien structur√© et que le contenu est correct.

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  check-structure:
    name: "üèóÔ∏è V√©rifier la structure du repo"
    runs-on: ubuntu-latest

    steps:
      # √âtape 1 : R√©cup√©rer le code du repo
      - name: Checkout du code
        uses: actions/checkout@v4

      # √âtape 2 : V√©rifier que les fichiers obligatoires existent
      - name: V√©rifier les fichiers obligatoires
        run: |
          echo "=== V√©rification des fichiers obligatoires ==="
          MISSING=0

          # Liste des fichiers qui doivent exister
          FILES=(
            "README.md"
            "LICENSE"
            ".gitignore"
            "ROADMAP.md"
            "PROGRESS.md"
            "docs/START-HERE.md"
            "docs/rules-of-the-game.md"
            "docs/glossary.md"
            "docs/scoring.md"
            "docs/pipelines-cheatsheet.md"
            "docs/team-workflow-0-to-merge.md"
            "docs/roles-in-a-dev-team.md"
          )

          for f in "${FILES[@]}"; do
            if [ -f "$f" ]; then
              echo "‚úÖ $f"
            else
              echo "‚ùå MANQUANT: $f"
              MISSING=$((MISSING + 1))
            fi
          done

          if [ $MISSING -gt 0 ]; then
            echo ""
            echo "üö® $MISSING fichier(s) manquant(s) !"
            exit 1
          else
            echo ""
            echo "üéâ Tous les fichiers obligatoires sont pr√©sents."
          fi

      # √âtape 3 : V√©rifier que toutes les rooms existent
      - name: V√©rifier les rooms
        run: |
          echo "=== V√©rification des rooms ==="
          MISSING=0

          ROOMS=(
            "rooms/room-00-orientation"
            "rooms/room-01-version-control"
            "rooms/room-02-collaboration"
            "rooms/room-03-team-workflow"
            "rooms/room-04-github-gui"
            "rooms/room-05-pipelines"
            "rooms/room-06-testing"
            "rooms/room-07-release"
            "rooms/room-08-monitoring"
            "rooms/room-09-jenkins"
            "rooms/room-10-incident-response"
            "rooms/room-11-capstone"
          )

          for room in "${ROOMS[@]}"; do
            if [ -f "$room/README.md" ]; then
              echo "‚úÖ $room/README.md"
            else
              echo "‚ùå MANQUANT: $room/README.md"
              MISSING=$((MISSING + 1))
            fi
          done

          if [ $MISSING -gt 0 ]; then
            echo ""
            echo "üö® $MISSING room(s) sans README !"
            exit 1
          else
            echo ""
            echo "üéâ Toutes les rooms ont leur README."
          fi

      # √âtape 4 : V√©rifier le format markdown (pas de tabulations, fichiers non vides)
      - name: V√©rifier le format des fichiers markdown
        run: |
          echo "=== V√©rification du format markdown ==="
          ERRORS=0

          # V√©rifier que les fichiers .md ne sont pas vides
          for f in $(find . -name "*.md" -not -path "./.git/*"); do
            if [ ! -s "$f" ]; then
              echo "‚ùå VIDE: $f"
              ERRORS=$((ERRORS + 1))
            fi
          done

          # V√©rifier le nombre total de fichiers markdown
          COUNT=$(find . -name "*.md" -not -path "./.git/*" | wc -l)
          echo "üìÑ $COUNT fichiers markdown trouv√©s."

          if [ $ERRORS -gt 0 ]; then
            echo ""
            echo "üö® $ERRORS fichier(s) markdown vide(s) !"
            exit 1
          else
            echo ""
            echo "üéâ Tous les fichiers markdown ont du contenu."
          fi

      # √âtape 5 : V√©rifier les liens internes markdown
      - name: V√©rifier les liens internes
        run: |
          echo "=== V√©rification des liens internes ==="
          BROKEN=0

          # Extraire les liens relatifs des fichiers markdown et v√©rifier qu'ils pointent vers des fichiers existants
          for mdfile in $(find . -name "*.md" -not -path "./.git/*"); do
            DIR=$(dirname "$mdfile")

            # Extraire les liens de type [texte](chemin) qui ne commencent pas par http
            LINKS=$(grep -oP '\[.*?\]\(\K[^)]+' "$mdfile" 2>/dev/null | grep -v '^http' | grep -v '^#' || true)

            for link in $LINKS; do
              # Retirer les ancres (#...)
              CLEAN=$(echo "$link" | sed 's/#.*//')
              if [ -n "$CLEAN" ]; then
                TARGET="$DIR/$CLEAN"
                if [ ! -e "$TARGET" ]; then
                  echo "‚ö†Ô∏è  Lien cass√© dans $mdfile ‚Üí $link"
                  BROKEN=$((BROKEN + 1))
                fi
              fi
            done
          done

          if [ $BROKEN -gt 0 ]; then
            echo ""
            echo "‚ö†Ô∏è  $BROKEN lien(s) potentiellement cass√©(s)."
            echo "V√©rifiez manuellement ‚Äî certains peuvent √™tre des ancres valides."
          else
            echo ""
            echo "üéâ Aucun lien cass√© d√©tect√©."
          fi
