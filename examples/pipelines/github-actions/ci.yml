# =============================================================================
# ğŸ“˜ Pipeline GitHub Actions â€” Version commentÃ©e pour apprendre
# =============================================================================
#
# Ce fichier est une copie pÃ©dagogique du pipeline rÃ©el (.github/workflows/ci.yml).
# Chaque ligne est expliquÃ©e pour que tu comprennes ce qui se passe.
#
# ğŸ’¡ Ce fichier ne s'exÃ©cute PAS (il n'est pas dans .github/workflows/).
#     C'est un support d'apprentissage.
# =============================================================================

# --- NOM DU PIPELINE ---
# Le nom apparaÃ®t dans l'onglet "Actions" de GitHub.
name: CI â€” DevOps Rooms

# --- DÃ‰CLENCHEUR ---
# "on" dÃ©finit QUAND le pipeline se lance.
# Ici : Ã  chaque push sur main, et Ã  chaque pull request vers main.
on:
  push:
    branches: [main]
    # â¡ï¸ Quand quelqu'un pousse du code directement sur la branche main
  pull_request:
    branches: [main]
    # â¡ï¸ Quand quelqu'un ouvre ou met Ã  jour une PR vers main

# --- JOBS ---
# Un job est un ensemble d'Ã©tapes qui s'exÃ©cutent sur une machine.
# Tu peux avoir plusieurs jobs, mais ici on en a un seul.
jobs:
  check-structure:
    # Nom affichÃ© dans l'interface GitHub
    name: "VÃ©rifier la structure du repo"

    # --- MACHINE ---
    # runs-on = sur quelle machine le job tourne
    # ubuntu-latest = une machine Linux dans le cloud de GitHub (gratuite)
    runs-on: ubuntu-latest

    # --- Ã‰TAPES ---
    # Les Ã©tapes s'exÃ©cutent dans l'ordre, l'une aprÃ¨s l'autre.
    steps:

      # Ã‰TAPE 1 : RÃ©cupÃ©rer le code
      # "uses" = utiliser une action existante (faite par quelqu'un d'autre)
      # actions/checkout@v4 = clone le repo sur la machine
      # Sans Ã§a, le pipeline n'a pas accÃ¨s au code !
      - name: Checkout du code
        uses: actions/checkout@v4

      # Ã‰TAPE 2 : VÃ©rifier que les fichiers importants existent
      # "run" = exÃ©cuter des commandes shell (bash)
      # Si une commande Ã©choue (exit 1), le pipeline passe en ROUGE âŒ
      - name: VÃ©rifier les fichiers obligatoires
        run: |
          echo "=== VÃ©rification des fichiers ==="
          ERREURS=0

          # On vÃ©rifie chaque fichier un par un
          for f in README.md LICENSE PROGRESS.md docs/START-HERE.md docs/glossary.md; do
            if [ -f "$f" ]; then
              echo "âœ… $f existe"
            else
              echo "âŒ $f manquant !"
              ERREURS=$((ERREURS + 1))
            fi
          done

          # Si au moins un fichier manque, on fait Ã©chouer le pipeline
          if [ $ERREURS -gt 0 ]; then
            echo "ğŸš¨ Il manque $ERREURS fichier(s)."
            exit 1
            # exit 1 = "il y a une erreur" â†’ le pipeline devient rouge
          fi

          echo "ğŸ‰ Tout est bon !"
          # Si on arrive ici, tout est vert âœ…

      # Ã‰TAPE 3 : VÃ©rifier que les rooms ont un README
      - name: VÃ©rifier les rooms
        run: |
          echo "=== VÃ©rification des rooms ==="
          for i in 00 01 02 03 04 05 06 07 08 09 10 11; do
            ROOM="rooms/room-$i-*/README.md"
            if ls $ROOM 1>/dev/null 2>&1; then
              echo "âœ… Room $i OK"
            else
              echo "âŒ Room $i : pas de README"
              exit 1
            fi
          done
          echo "ğŸ‰ Toutes les rooms sont complÃ¨tes."

      # Ã‰TAPE 4 : VÃ©rifier que les fichiers markdown ne sont pas vides
      - name: VÃ©rifier le contenu markdown
        run: |
          echo "=== VÃ©rification du contenu ==="
          VIDES=0
          TOTAL=0
          for f in $(find . -name "*.md" -not -path "./.git/*"); do
            TOTAL=$((TOTAL + 1))
            if [ ! -s "$f" ]; then
              echo "âŒ Fichier vide : $f"
              VIDES=$((VIDES + 1))
            fi
          done
          echo "ğŸ“„ $TOTAL fichiers markdown vÃ©rifiÃ©s."
          if [ $VIDES -gt 0 ]; then
            echo "ğŸš¨ $VIDES fichier(s) vide(s) !"
            exit 1
          fi
          echo "ğŸ‰ Aucun fichier vide."

# =============================================================================
# ğŸ“Œ RÃ‰SUMÃ‰
#
# Ce pipeline fait 4 choses :
# 1. RÃ©cupÃ¨re le code (checkout)
# 2. VÃ©rifie que les fichiers obligatoires existent
# 3. VÃ©rifie que chaque room a un README
# 4. VÃ©rifie que les fichiers markdown ne sont pas vides
#
# Si tout est OK â†’ vert âœ… (le code peut Ãªtre mergÃ©)
# Si quelque chose manque â†’ rouge âŒ (il faut corriger avant de merger)
#
# ğŸ”— Le vrai pipeline est dans : .github/workflows/ci.yml
# =============================================================================
